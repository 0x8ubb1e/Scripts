<!DOCTYPE html>
<html lang="zh">

<head>
	<meta charset="UTF-8">
	<meta name="version" content="2.0" />
	<title>HTML 文件浏览器（递归版）</title>
	<style>
		body {
			font-family: sans-serif;
			padding: 2em;
		}

		button {
			margin: 0.5em;
			padding: 0.5em 1em;
			font-size: 1em;
		}

		#info {
			margin-top: 1em;
			font-size: 1.2em;
		}

		#log {
			margin-top: 1em;
			font-size: 0.9em;
			color: #555;
		}
	</style>
</head>

<body>

	<h1>HTML 文件浏览器（递归扫描版）</h1>
	<button onclick="startBrowsing('sequential')">顺序浏览</button>
	<button onclick="startBrowsing('random')">随机浏览</button>
	<div id="info">正在扫描文件……</div>
	<div id="log"></div>

	<script>
		const allFiles = [];
		let viewed = 0;
		let queue = [];
		const storageKey = 'html_viewed_list';

		// 递归扫描目录
		async function scanDir (path = './') {
			const res = await fetch(path);
			const text = await res.text();
			const doc = new DOMParser().parseFromString(text, 'text/html');
			const links = Array.from(doc.querySelectorAll('a'));

			for (const a of links) {
				const href = a.getAttribute('href');
				if (!href) continue;
				const name = href.split('/').pop();
				if (href.endsWith('/')) {
					// 是目录，递归扫描
					await scanDir(path + href);
				} else if (href.endsWith('.html') && name !== 'manager.html') {
					allFiles.push(path + href);
				}
			}
		}

		async function init () {
			await scanDir();
			remaining = allFiles.length;
			document.getElementById('info').innerText = `扫描完成，共找到 ${allFiles.length} 个 .html 文件`;
		}

		function updateInfo () {
			document.getElementById('info').innerText = `已看：${viewed} / 总计：${allFiles.length}，剩余：${allFiles.length - viewed}`;
		}

		function getViewedList () {
			try {
				return JSON.parse(localStorage.getItem(storageKey) || '[]');
			} catch {
				return [];
			}
		}

		function markViewed (file) {
			const viewedList = getViewedList();
			if (!viewedList.includes(file)) {
				viewedList.push(file);
				localStorage.setItem(storageKey, JSON.stringify(viewedList));
			}
		}

		function startBrowsing (mode) {
			const viewedList = getViewedList();
			const unseen = allFiles.filter(f => !viewedList.includes(f));
			if (unseen.length === 0) {
				alert('所有文件都已浏览完成！');
				return;
			}
			queue = mode === 'random' ? unseen.sort(() => Math.random() - 0.5) : unseen;
			openNext();
		}

		function openNext () {
			if (queue.length === 0) {
				alert('本轮浏览完成！');
				return;
			}
			const next = queue.shift();
			const win = window.open(next, '_blank');
			if (!win) {
				alert('请允许弹出窗口');
				return;
			}
			viewed++;
			markViewed(next);
			updateInfo();
			const timer = setInterval(() => {
				if (win.closed) {
					clearInterval(timer);
					openNext();
				}
			}, 1000);
		}

		init();
	</script>

</body>

</html>