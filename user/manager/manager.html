<!DOCTYPE html>
<html lang="zh">

<head>
	<meta charset="UTF-8">
	<meta name="version" content="3.0" />
	<title>HTML 浏览器（本地可用版）</title>
	<style>
		body {
			font-family: sans-serif;
			padding: 2em;
		}

		button {
			margin: 0.5em;
			padding: 0.5em 1em;
			font-size: 1em;
		}

		#info {
			margin-top: 1em;
			font-size: 1.2em;
		}
	</style>
</head>

<body>
	<h1>HTML 文件浏览器（本地可用版）</h1>
	<button onclick="startBrowsing('sequential')">顺序浏览</button>
	<button onclick="startBrowsing('random')">随机浏览</button>
	<button onclick="resetProgress()">重置进度</button>
	<button onclick="exportList()">导出已看列表</button>
	<div id="info">正在加载文件列表……</div>

	<script>
		let allFiles = [];
		let viewed = 0;
		let queue = [];
		const storageKey = 'html_viewed_list';

		// 读取 file_list.json
		fetch('./file_list.json')
			.then(res => res.json())
			.then(data => {
				allFiles = data;
				updateInfo();
			})
			.catch(() => {
				document.getElementById('info').innerText = '找不到 file_list.json，请先运行 generate_list.py';
			});

		function updateInfo () {
			const viewedList = getViewedList();
			viewed = viewedList.length;
			const remaining = allFiles.length - viewed;
			document.getElementById('info').innerText = `已看：${viewed} / 总计：${allFiles.length}，剩余：${remaining}`;
		}

		function getViewedList () {
			try {
				return JSON.parse(localStorage.getItem(storageKey) || '[]');
			} catch {
				return [];
			}
		}

		function markViewed (file) {
			const list = getViewedList();
			if (!list.includes(file)) {
				list.push(file);
				localStorage.setItem(storageKey, JSON.stringify(list));
			}
		}

		function resetProgress () {
			if (confirm('确定要重置所有浏览进度吗？')) {
				localStorage.removeItem(storageKey);
				updateInfo();
				alert('已重置');
			}
		}

		function exportList () {
			const list = getViewedList();
			const blob = new Blob([JSON.stringify(list, null, 2)], { type: 'application/json' });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = 'viewed_files.json';
			a.click();
		}

		function startBrowsing (mode) {
			const viewedList = getViewedList();
			const unseen = allFiles.filter(f => !viewedList.includes(f));
			if (unseen.length === 0) {
				alert('全部浏览完成！');
				return;
			}
			queue = mode === 'random' ? unseen.sort(() => Math.random() - 0.5) : unseen;
			openNext();
		}

		function openNext () {
			if (queue.length === 0) {
				alert('本轮完成！');
				return;
			}
			const next = queue.shift();
			const win = window.open(next, '_blank');
			if (!win) {
				alert('请允许弹出窗口');
				return;
			}
			markViewed(next);
			updateInfo();
			const timer = setInterval(() => {
				if (win.closed) {
					clearInterval(timer);
					openNext();
				}
			}, 1000);
		}
	</script>
</body>

</html>