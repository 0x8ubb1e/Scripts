<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="version" content="1.0.0">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>每日任务提醒</title>
	<style>
		body {
			font-family: 'Microsoft YaHei', sans-serif;
			margin: 0;
			padding: 0;
			background-color: #f5f5f5;
			user-select: none;
			box-sizing: border-box;
		}

		.task-container {
			width: 300px;
			background-color: white;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
			border-radius: 8px;
			position: absolute;
			top: 50px;
			left: 50px;
			overflow: hidden;
			resize: both;
			min-width: 280px;
			/* min-height: 350px; */
			max-width: 500px;
			max-height: 700px;
		}

		.task-header {
			background-color: #4CAF50;
			color: white;
			padding: 12px 15px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			cursor: move;
		}

		.task-title {
			font-weight: bold;
			font-size: 16px;
		}

		.task-controls {
			display: flex;
			gap: 8px;
		}

		.task-controls button {
			background: transparent;
			border: none;
			color: white;
			cursor: pointer;
			font-size: 16px;
			padding: 2px;
			width: 30px;
			height: 30px;
		}

		.task-list {
			max-height: 300px;
			overflow-y: auto;
			padding: 10px;
		}

		.task-item {
			padding: 10px;
			border-bottom: 1px solid #eee;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.task-item:last-child {
			border-bottom: none;
		}

		.task-content {
			display: flex;
			flex-direction: column;
			flex-grow: 1;
		}

		.task-name {
			font-weight: bold;
			margin-bottom: 5px;
		}

		.task-time {
			font-size: 12px;
			color: #777;
		}

		.task-actions {
			display: flex;
			gap: 5px;
		}

		.task-actions button {
			background: transparent;
			border: none;
			cursor: pointer;
			font-size: 14px;
			color: #777;
		}

		.task-actions button:hover {
			color: #4CAF50;
		}

		.add-task {
			padding: 15px;
			border-top: 1px solid #eee;
		}

		.add-task input,
		.add-task button {
			width: 100%;
			padding: 8px;
			margin-bottom: 5px;
			border: 1px solid #ddd;
			border-radius: 4px;
			box-sizing: border-box;
		}

		.add-task button {
			background-color: #4CAF50;
			color: white;
			border: none;
			cursor: pointer;
		}

		.add-task button:hover {
			background-color: #45a049;
		}

		.notification {
			position: fixed;
			top: 20px;
			right: 20px;
			background-color: #4CAF50;
			color: white;
			padding: 40px 30px 10px;
			border-radius: 5px;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
			z-index: 1000;
			max-width: 300px;
			display: none;
		}

		.notification h3 {
			position: absolute;
			top: 10px;
			left: 10px;
			margin-top: 0;
			margin-bottom: 5px;
		}

		.notification p {
			margin: 5px 0;
		}

		.notification-close {
			position: absolute;
			top: 5px;
			right: 5px;
			background: transparent;
			border: none;
			color: white;
			cursor: pointer;
			font-size: 30px;
		}

		.empty-message {
			text-align: center;
			color: #888;
			padding: 20px;
			font-style: italic;
		}
	</style>
</head>

<body>
	<div class="task-container" id="taskContainer">
		<div class="task-header" id="taskHeader">
			<div class="task-title">每日任务提醒</div>
			<div class="task-controls">
				<button id="pinBtn" title="置顶/取消置顶">📌</button>
				<button id="minimizeBtn" title="最小化">─</button>
			</div>
		</div>
		<div class="task-list" id="taskList">
			<div class="empty-message">暂无任务，请添加新任务</div>
		</div>
		<div class="add-task">
			<input type="text" id="taskInput" placeholder="任务名称" maxlength="50">
			<input type="time" id="timeInput">
			<button id="addTaskBtn">添加任务</button>
		</div>
	</div>

	<div class="notification" id="notification">
		<button class="notification-close" id="notificationClose">×</button>
		<h3>任务提醒</h3>
		<p id="notificationTaskName"></p>
		<p id="notificationTaskTime"></p>
	</div>

	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const taskContainer = document.getElementById('taskContainer');
			const taskHeader = document.getElementById('taskHeader');
			const taskList = document.getElementById('taskList');
			const taskInput = document.getElementById('taskInput');
			const timeInput = document.getElementById('timeInput');
			const addTaskBtn = document.getElementById('addTaskBtn');
			const pinBtn = document.getElementById('pinBtn');
			const minimizeBtn = document.getElementById('minimizeBtn');
			const notification = document.getElementById('notification');
			const notificationClose = document.getElementById('notificationClose');
			const notificationTaskName = document.getElementById('notificationTaskName');
			const notificationTaskTime = document.getElementById('notificationTaskTime');

			let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
			let isPinned = localStorage.getItem('isPinned') === 'true';
			let isMinimized = localStorage.getItem('isMinimized') === 'true';
			let reminders = {};

			// 初始化
			function init () {
				renderTasks();
				setContainerPosition();
				setPinState();
				setMinimizeState();
				setupReminders();

				// 设置当前时间为默认时间
				const now = new Date();
				const hours = String(now.getHours()).padStart(2, '0');
				const minutes = String(now.getMinutes()).padStart(2, '0');
				timeInput.value = `${hours}:${minutes}`;
			}

			// 渲染任务列表
			function renderTasks () {
				if (tasks.length === 0) {
					taskList.innerHTML = '<div class="empty-message">暂无任务，请添加新任务</div>';
					return;
				}

				taskList.innerHTML = '';
				tasks.forEach((task, index) => {
					const taskElement = document.createElement('div');
					taskElement.className = 'task-item';

					taskElement.innerHTML = `
						<div class="task-content">
							<div class="task-name">${task.name}</div>
							<div class="task-time">${task.time}</div>
						</div>
						<div class="task-actions">
							<button class="delete-task" data-index="${index}">❌</button>
						</div>
					`;

					taskList.appendChild(taskElement);
				});

				// 添加删除事件监听
				document.querySelectorAll('.delete-task').forEach(button => {
					button.addEventListener('click', function () {
						const index = parseInt(this.getAttribute('data-index'));
						deleteTask(index);
					});
				});
			}

			// 添加新任务
			function addTask (name, time) {
				if (!name.trim()) {
					alert('请输入任务名称');
					return;
				}

				const newTask = {
					name: name.trim(),
					time: time
				};

				tasks.push(newTask);
				saveTasks();
				renderTasks();
				setupReminders();

				taskInput.value = '';
			}

			// 删除任务
			function deleteTask (index) {
				if (confirm('确定要删除这个任务吗？')) {
					tasks.splice(index, 1);
					saveTasks();
					renderTasks();
					setupReminders();
				}
			}

			// 保存任务到本地存储
			function saveTasks () {
				localStorage.setItem('tasks', JSON.stringify(tasks));
			}

			// 保存窗口位置
			function saveContainerPosition () {
				localStorage.setItem('containerTop', taskContainer.style.top);
				localStorage.setItem('containerLeft', taskContainer.style.left);
			}

			// 设置窗口位置
			function setContainerPosition () {
				const savedTop = localStorage.getItem('containerTop');
				const savedLeft = localStorage.getItem('containerLeft');

				if (savedTop && savedLeft) {
					taskContainer.style.top = savedTop;
					taskContainer.style.left = savedLeft;
				}
			}

			// 设置置顶状态
			function setPinState () {
				if (isPinned) {
					taskContainer.style.zIndex = '9999';
					pinBtn.textContent = '📍';
					pinBtn.title = '取消置顶';
				} else {
					taskContainer.style.zIndex = '100';
					pinBtn.textContent = '📌';
					pinBtn.title = '置顶';
				}
			}

			// 设置最小化状态
			function setMinimizeState () {
				if (isMinimized) {
					taskList.style.display = 'none';
					document.querySelector('.add-task').style.display = 'none';
					minimizeBtn.textContent = '▢';
					minimizeBtn.title = '还原';
				} else {
					taskList.style.display = 'block';
					document.querySelector('.add-task').style.display = 'block';
					minimizeBtn.textContent = '─';
					minimizeBtn.title = '最小化';
				}
			}

			// 设置提醒
			function setupReminders () {
				// 清除所有存在的提醒
				for (const key in reminders) {
					clearTimeout(reminders[key]);
				}
				reminders = {};

				// 为每个任务设置新的提醒
				tasks.forEach((task, index) => {
					const [hours, minutes] = task.time.split(':').map(Number);
					const now = new Date();
					const taskTime = new Date();

					taskTime.setHours(hours, minutes, 0, 0);

					// 如果任务时间已过，设置为明天
					if (taskTime <= now) {
						taskTime.setDate(taskTime.getDate() + 1);
					}

					const timeUntilTask = taskTime.getTime() - now.getTime();

					reminders[index] = setTimeout(() => {
						showNotification(task.name, task.time);
						// 设置下一天的提醒
						setupReminders();
					}, timeUntilTask);
				});
			}

			// 显示通知
			function showNotification (taskName, taskTime) {
				notificationTaskName.textContent = `任务: ${taskName}`;
				notificationTaskTime.textContent = `时间: ${taskTime}`;
				notification.style.display = 'block';

				// 播放提示音
				const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
				audio.play().catch(e => console.log('无法播放提示音:', e));

				// 如果浏览器支持通知API，则使用系统通知
				if ('Notification' in window && Notification.permission === 'granted') {
					new Notification('任务提醒', {
						body: `任务: ${taskName} 时间: ${taskTime}`,
						icon: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%234CAF50"/><text x="50" y="55" font-size="40" text-anchor="middle" fill="white">!</text></svg>'
					});
				}
			}

			// 请求通知权限
			if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
				Notification.requestPermission();
			}

			// 拖动窗口功能
			let isDragging = false;
			let offsetX, offsetY;

			taskHeader.addEventListener('mousedown', function (e) {
				isDragging = true;
				offsetX = e.clientX - taskContainer.getBoundingClientRect().left;
				offsetY = e.clientY - taskContainer.getBoundingClientRect().top;
				taskContainer.style.cursor = 'grabbing';
			});

			document.addEventListener('mousemove', function (e) {
				if (isDragging) {
					taskContainer.style.left = (e.clientX - offsetX) + 'px';
					taskContainer.style.top = (e.clientY - offsetY) + 'px';
				}
			});

			document.addEventListener('mouseup', function () {
				if (isDragging) {
					isDragging = false;
					taskContainer.style.cursor = 'default';
					saveContainerPosition();
				}
			});

			// 事件监听
			addTaskBtn.addEventListener('click', function () {
				addTask(taskInput.value, timeInput.value);
			});

			taskInput.addEventListener('keypress', function (e) {
				if (e.key === 'Enter') {
					addTask(taskInput.value, timeInput.value);
				}
			});

			pinBtn.addEventListener('click', function () {
				isPinned = !isPinned;
				localStorage.setItem('isPinned', isPinned);
				setPinState();
			});

			minimizeBtn.addEventListener('click', function () {
				isMinimized = !isMinimized;
				localStorage.setItem('isMinimized', isMinimized);
				setMinimizeState();
			});

			notificationClose.addEventListener('click', function () {
				notification.style.display = 'none';
			});

			// 初始化应用
			init();
		});
	</script>
</body>

</html>